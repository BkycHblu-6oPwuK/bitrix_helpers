# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –º–æ–¥—É–ª—è beeralex.notification

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
3. [–£—Å—Ç–∞–Ω–æ–≤–∫–∞](#—É—Å—Ç–∞–Ω–æ–≤–∫–∞)
4. [–ë–∞–∑–æ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏](#–±–∞–∑–æ–≤—ã–µ-–∫–æ–Ω—Ü–µ–ø—Ü–∏–∏)
5. [NotificationManager](#notificationmanager)
6. [–ö–∞–Ω–∞–ª—ã –¥–æ—Å—Ç–∞–≤–∫–∏](#–∫–∞–Ω–∞–ª—ã-–¥–æ—Å—Ç–∞–≤–∫–∏)
7. [–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è](#–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ-–ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è)
8. [–¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π](#—Ç–∏–ø—ã-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)
9. [–ü–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π](#–ø–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫–∏-—Å–æ–±—ã—Ç–∏–π)
10. [–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞](#—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ-—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞)
11. [REST API](#rest-api)
12. [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä—ã-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)

---

## –û–±–∑–æ—Ä

**beeralex.notification** ‚Äî —ç—Ç–æ –º–æ–¥—É–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –≤ Bitrix —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π:

- üìß **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –¥–æ—Å—Ç–∞–≤–∫–∏**: Email, SMS, Telegram, Push (—Ä–∞—Å—à–∏—Ä—è–µ–º–æ)
- üéõÔ∏è **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π**: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –ø–æ –∫–∞–Ω–∞–ª–∞–º –∏ —Ç–∏–ø–∞–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- üîå **–ü–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π Bitrix (–ø–æ—á—Ç–∞, SMS)
- üß© **–†–∞—Å—à–∏—Ä—è–µ–º–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã**: –ª–µ–≥–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ —á–µ—Ä–µ–∑ event-based —Å–∏—Å—Ç–µ–º—É
- üìä **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è**: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∞–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, –∫–∞–Ω–∞–ª–∞–º–∏, —à–∞–±–ª–æ–Ω–∞–º–∏ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É

### –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ —Ä–∞–∑–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –∫–∞–Ω–∞–ª–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –ø–æ—á—Ç–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π Bitrix
- –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ (NotificationLock)
- –ö–æ–Ω—Ç—Ä–∞–∫—Ç–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (Repository pattern)

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –î–∏–∞–≥—Ä–∞–º–º–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          NotificationManager                    ‚îÇ
‚îÇ  (–û—Å–Ω–æ–≤–Ω–æ–π –º–µ–Ω–µ–¥–∂–µ—Ä –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ                           ‚îÇ
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚îÇ Repositories ‚îÇ            ‚îÇ ChannelFactory  ‚îÇ
      ‚îÇ              ‚îÇ            ‚îÇ ChannelRegistry ‚îÇ
      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                         ‚îÇ
                           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                           ‚îÇ             ‚îÇ             ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇEmailChannel‚îÇ ‚îÇSmsChannel‚îÇ ‚îÇTelegramCh..‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **NotificationManager** ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä, –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É—é—â–∏–π –æ—Ç–ø—Ä–∞–≤–∫—É
2. **ChannelFactory** ‚Äî —Ñ–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –∫–∞–Ω–∞–ª–æ–≤
3. **ChannelRegistry** ‚Äî —Ä–µ–µ—Å—Ç—Ä –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ —Å —Å–æ–±—ã—Ç–∏–π–Ω—ã–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º
4. **Channels/** ‚Äî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞–Ω–∞–ª–æ–≤ –¥–æ—Å—Ç–∞–≤–∫–∏
5. **Repositories/** ‚Äî —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏
6. **Events/** ‚Äî –ø–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π Bitrix
7. **Tables/** ‚Äî ORM-—Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

---

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- PHP 8.1+
- Bitrix Framework 22.0+
- –ú–æ–¥—É–ª–∏: `main`, `fileman` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –ú–æ–¥—É–ª—å `beeralex.core` (–±–∞–∑–æ–≤—ã–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏)

### –ü—Ä–æ—Ü–µ—Å—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏

1. –†–∞–∑–º–µ—Å—Ç–∏—Ç–µ –º–æ–¥—É–ª—å –≤ `/local/modules/beeralex.notification/`
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—É—é –ø–∞–Ω–µ–ª—å –∏–ª–∏ CLI
3. –ú–æ–¥—É–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
   - –°–æ–∑–¥–∞—Å—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –ë–î
   - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Å–µ—Ä–≤–∏—Å—ã –≤ DI-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
   - –ü–æ–¥–∫–ª—é—á–∏—Ç –ø–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü –ë–î

```sql
-- –ö–∞–Ω–∞–ª—ã –¥–æ—Å—Ç–∞–≤–∫–∏
beeralex_notification_channels (ID, CODE, NAME, ACTIVE, SORT)

-- –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
beeralex_notification_types (ID, CODE, NAME)

-- –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
beeralex_user_notification_preferences (USER_ID, NOTIFICATION_TYPE_ID, CHANNEL_ID, ENABLED)

-- –°–≤—è–∑—å —Ç–∏–ø–æ–≤ —Å —Å–æ–±—ã—Ç–∏—è–º–∏
beeralex_notification_link_event_types (ID, EVENT_NAME, EVENT_TYPE_CODE)

-- –°–≤—è–∑—å —à–∞–±–ª–æ–Ω–æ–≤ —Å —Ç–∏–ø–∞–º–∏
beeralex_notification_template_links (ID, TEMPLATE_ID, NOTIFICATION_TYPE_ID)

-- –ö–æ–¥—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
beeralex_notification_codes (ID, CODE, NAME)

-- –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
beeralex_notifications (ID, USER_ID, CHANNEL_ID, TYPE_ID, SENT_AT, STATUS)
```

---

## –ë–∞–∑–æ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

### NotificationMessage DTO

–û–±—ä–µ–∫—Ç-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:

```php
namespace Beeralex\Notification\Dto;

class NotificationMessage
{
    public function __construct(
        public string $eventName,      // –ò–º—è —Å–æ–±—ã—Ç–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'NEW_ORDER')
        public array $fields,          // –ü–æ–ª—è –¥–ª—è —à–∞–±–ª–æ–Ω–∞
        public int $userId,            // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è-–ø–æ–ª—É—á–∞—Ç–µ–ª—è
        public ?string $lid = null,    // ID —Å–∞–π—Ç–∞
        public ?string $messageId = null,  // ID –ø–æ—á—Ç–æ–≤–æ–≥–æ —à–∞–±–ª–æ–Ω–∞
        public ?array $files = null,   // –í–ª–æ–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        public ?string $languageId = null  // –Ø–∑—ã–∫ —Å–æ–æ–±—â–µ–Ω–∏—è
    ) {}
}
```

### Enum Channel

–ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤:

```php
namespace Beeralex\Notification\Enum;

enum Channel: string
{
    case EMAIL = 'email';
    case SMS = 'sms';
    case TELEGRAM = 'telegram';
    case PUSH = 'push';
}
```

---

## NotificationManager

–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –≤—ã–±–æ—Ä–æ–º –∫–∞–Ω–∞–ª–æ–≤.

### –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã

1. –ü–æ–ª—É—á–∞–µ—Ç —Ç–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Å–æ–±—ã—Ç–∏–µ–º
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã

### –ú–µ—Ç–æ–¥—ã

#### `notify(NotificationMessage $message): void`

–û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.

```php
use Beeralex\Notification\NotificationManager;
use Beeralex\Notification\Dto\NotificationMessage;

$manager = new NotificationManager();

$message = new NotificationMessage(
    eventName: 'NEW_ORDER',
    fields: [
        'USER_NAME' => '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤',
        'ORDER_ID' => 12345,
        'ORDER_TOTAL' => '5000 —Ä—É–±.'
    ],
    userId: 100
);

$manager->notify($message);
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç —á–µ—Ä–µ–∑ –≤—Å–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
```

#### `sendToChannel(string $code, NotificationMessage $message): void`

–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –º–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–∞–Ω–∞–ª (protected).

**–õ–æ–≥–∏–∫–∞:**
1. –°–æ–∑–¥–∞–µ—Ç –∫–∞–Ω–∞–ª —á–µ—Ä–µ–∑ ChannelFactory
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ `OnBeforeSendToChannel` (–¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞/–º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏)
3. –í—ã–∑—ã–≤–∞–µ—Ç –º–µ—Ç–æ–¥ `send()` –∫–∞–Ω–∞–ª–∞
4. –õ–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫–∏ –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ

---

## –ö–∞–Ω–∞–ª—ã –¥–æ—Å—Ç–∞–≤–∫–∏

### –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å NotificationChannelContract

–í—Å–µ –∫–∞–Ω–∞–ª—ã –¥–æ–ª–∂–Ω—ã —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å:

```php
namespace Beeralex\Notification\Contracts;

interface NotificationChannelContract
{
    /**
     * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–∞–Ω–∞–ª
     */
    public function send(NotificationMessage $message): \Bitrix\Main\Result;

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–µ–ª–æ–≤–µ–∫–æ–ø–æ–Ω—è—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
     */
    public static function getDisplayName(): string;

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –∫–∞–Ω–∞–ª–∞
     */
    public static function getCode(): string;
}
```

### EmailChannel

–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Å–∏—Å—Ç–µ–º—É –ø–æ—á—Ç–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π Bitrix.

```php
namespace Beeralex\Notification\Channels;

class EmailChannel implements NotificationChannelContract
{
    public function send(NotificationMessage $message): \Bitrix\Main\Result
    {
        return Event::send([
            'EVENT_NAME' => $message->eventName,
            'LID' => $message->lid ?? SITE_ID ?: 's1',
            'C_FIELDS' => $message->fields,
            'MESSAGE_ID' => $message->messageId,
            'FILES' => $message->files,
            'LANGUAGE_ID' => $message->languageId,
        ]);
    }

    public static function getCode(): string
    {
        return Channel::EMAIL->value; // 'email'
    }

    public static function getDisplayName(): string
    {
        return 'Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
    }
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```php
$channel = new EmailChannel();
$result = $channel->send($message);

if (!$result->isSuccess()) {
    echo implode('; ', $result->getErrorMessages());
}
```

### SmsChannel

–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç SMS-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π SmsEvent.

```php
namespace Beeralex\Notification\Channels;

class SmsChannel implements NotificationChannelContract
{
    public function send(NotificationMessage $message): \Bitrix\Main\Result
    {
        return (new SmsEvent($message->eventName, $message->fields))->send();
    }

    public static function getCode(): string
    {
        return Channel::SMS->value; // 'sms'
    }

    public static function getDisplayName(): string
    {
        return 'SMS —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
    }
}
```

### TelegramChannel

‚ö†Ô∏è **–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ** ‚Äî –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –±—É–¥—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.

```php
namespace Beeralex\Notification\Channels;

class TelegramChannel implements NotificationChannelContract
{
    public function send(NotificationMessage $message): \Bitrix\Main\Result
    {
        // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —á–µ—Ä–µ–∑ Telegram Bot API
        return new \Bitrix\Main\Result();
    }

    public static function getCode(): string
    {
        return Channel::TELEGRAM->value; // 'telegram'
    }

    public static function getDisplayName(): string
    {
        return 'Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
    }
}
```

---

## ChannelFactory –∏ ChannelRegistry

### ChannelFactory

–§–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –∫–∞–Ω–∞–ª–æ–≤ –ø–æ –∏—Ö –∫–æ–¥—É.

```php
use Beeralex\Notification\ChannelFactory;

$channel = ChannelFactory::createChannel('email');
// –í–µ—Ä–Ω–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä EmailChannel –∏–ª–∏ null, –µ—Å–ª–∏ –∫–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```php
class ChannelFactory
{
    public static function createChannel(string $code): ?NotificationChannelContract
    {
        $channels = ChannelRegistry::getAvailableChannels();
        
        foreach ($channels as $class) {
            if (is_subclass_of($class, NotificationChannelContract::class) 
                && $class::getCode() === $code) {
                return new $class;
            }
        }

        return null;
    }
}
```

### ChannelRegistry

–†–µ–µ—Å—Ç—Ä –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è.

**–î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∫–∞–Ω–∞–ª—ã:**

```php
class ChannelRegistry
{
    protected static array $defaultChannels = [
        Channels\EmailChannel::class,
        Channels\SmsChannel::class,
        Channels\TelegramChannel::class,
    ];
}
```

**–ú–µ—Ç–æ–¥ getAvailableChannels():**

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤ (–¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ + –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏–µ).

```php
$channels = ChannelRegistry::getAvailableChannels();
// ['EmailChannel', 'SmsChannel', 'TelegramChannel', ...]
```

---

## –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è

### UserNotificationPreferenceTable

ORM-—Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```php
class UserNotificationPreferenceTable extends DataManager
{
    // –ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á
    USER_ID (int, PK)
    NOTIFICATION_TYPE_ID (int, PK)
    CHANNEL_ID (int, PK)
    ENABLED (boolean, Y/N, default: Y)
}
```

### UserNotificationPreferenceRepository

–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º–∏.

#### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã

**getByUser(int $userId): array**

–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

```php
$preferenceRepo = service(UserNotificationPreferenceRepositoryContract::class);
$preferences = $preferenceRepo->getByUser(100);

// [
//   ['USER_ID' => 100, 'NOTIFICATION_TYPE_ID' => 1, 'CHANNEL_ID' => 1, 'ENABLED' => 'Y'],
//   ['USER_ID' => 100, 'NOTIFICATION_TYPE_ID' => 1, 'CHANNEL_ID' => 2, 'ENABLED' => 'N'],
//   ...
// ]
```

**isEnabled(int $userId, int $typeId, int $channelId): bool**

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –≤–∫–ª—é—á–µ–Ω –ª–∏ –∫–∞–Ω–∞–ª –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

```php
$isEnabled = $preferenceRepo->isEnabled(
    userId: 100,
    notificationTypeId: 1, // –ù–∞–ø—Ä–∏–º–µ—Ä, "–ù–æ–≤—ã–π –∑–∞–∫–∞–∑"
    channelId: 1           // Email
);

if ($isEnabled) {
    echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑—Ä–µ—à–∏–ª –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–∞—Ö –Ω–∞ email";
}
```

**setEnabled(int $userId, int $typeId, int $channelId, bool $enabled): void**

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

```php
// –û—Ç–∫–ª—é—á–∏—Ç—å email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–∞—Ö
$preferenceRepo->setEnabled(
    userId: 100,
    notificationTypeId: 1,
    channelId: 1,
    enabled: false
);

// –í–∫–ª—é—á–∏—Ç—å SMS-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
$preferenceRepo->setEnabled(
    userId: 100,
    notificationTypeId: 1,
    channelId: 2,
    enabled: true
);
```

**getUserPreference(int $userId, int $typeId, int $channelId): ?array**

–ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ.

```php
$pref = $preferenceRepo->getUserPreference(100, 1, 1);
// ['USER_ID' => 100, 'NOTIFICATION_TYPE_ID' => 1, 'CHANNEL_ID' => 1, 'ENABLED' => 'Y']
```

---

## –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### NotificationTypeTable

ORM-—Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```php
ID (int, PK, auto)
CODE (string, unique, required)  // –ù–∞–ø—Ä–∏–º–µ—Ä: 'NEW_ORDER', 'PASSWORD_RESET'
NAME (string, required)          // –ß–µ–ª–æ–≤–µ–∫–æ–ø–æ–Ω—è—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
```

### NotificationTypeRepository

#### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã

**getByCode(string $code): ?array**

–ü–æ–ª—É—á–∏—Ç—å —Ç–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ –∫–æ–¥—É.

```php
$typeRepo = service(NotificationTypeRepositoryContract::class);
$type = $typeRepo->getByCode('NEW_ORDER');

// ['ID' => 1, 'CODE' => 'NEW_ORDER', 'NAME' => '–ù–æ–≤—ã–π –∑–∞–∫–∞–∑']
```

**getAllTypes(): array**

–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ç–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

```php
$types = $typeRepo->getAllTypes();
// [
//   ['ID' => 1, 'CODE' => 'NEW_ORDER', 'NAME' => '–ù–æ–≤—ã–π –∑–∞–∫–∞–∑'],
//   ['ID' => 2, 'CODE' => 'PASSWORD_RESET', 'NAME' => '–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è'],
//   ...
// ]
```

**exists(string $code): bool**

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–∞.

```php
if ($typeRepo->exists('NEW_ORDER')) {
    echo "–¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è 'NEW_ORDER' —Å—É—â–µ—Å—Ç–≤—É–µ—Ç";
}
```

**addIfNotExists(string $code, string $name): int**

–î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π –º–µ—Ç–æ–¥).

```php
$typeId = $typeRepo->addIfNotExists('NEW_ORDER', '–ù–æ–≤—ã–π –∑–∞–∫–∞–∑');
// –í–µ—Ä–Ω–µ—Ç ID —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
```

---

## –ü–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π

### MailEventInterceptor

–ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ—á—Ç–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è Bitrix –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏—Ö —á–µ—Ä–µ–∑ NotificationManager.

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**

1. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è `OnBeforeEventSend`
2. –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø–æ—á—Ç—ã —á–µ—Ä–µ–∑ `\Bitrix\Main\Mail\Event::send()` –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–∑–æ–≤
3. –°–æ–∑–¥–∞–µ—Ç `NotificationMessage` –∏ –ø–µ—Ä–µ–¥–∞–µ—Ç –≤ `NotificationManager`
4. –ë–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `false`)

**–ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏:**

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç `NotificationLock` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è:

```php
if (NotificationLock::isLocked(Channel::EMAIL->value)) {
    return true; // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
}

NotificationLock::lock(Channel::EMAIL->value);
try {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    $manager->notify($message);
} finally {
    NotificationLock::unlock(Channel::EMAIL->value);
}
```

**–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞:**

```php
class MailEventInterceptor
{
    public function handle(
        string $eventName,
        string $lid,
        array $fields,
        ?string $messageId = null,
        ?array $files = null,
        ?string $languageId = null
    ): bool {
        if (!$this->moduleEnable || NotificationLock::isLocked(Channel::EMAIL->value)) {
            return true; // –ü–µ—Ä–µ–¥–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ
        }

        $userId = service(UserRepositoryContract::class)->getCurrentUser()->getId();
        if (!$userId) {
            return true;
        }

        NotificationLock::lock(Channel::EMAIL->value);
        try {
            $message = new NotificationMessage($eventName, $fields, $userId, $lid, $messageId, $files, $languageId);
            $manager = new NotificationManager();
            $manager->notify($message);
        } finally {
            NotificationLock::unlock(Channel::EMAIL->value);
        }

        return false; // –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
    }
}
```

### SmsEventInterceptor

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç SMS-—Å–æ–±—ã—Ç–∏—è Bitrix.

---

## –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞ –¥–æ—Å—Ç–∞–≤–∫–∏

#### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å –∫–∞–Ω–∞–ª–∞

```php
namespace App\Notification\Channels;

use Beeralex\Notification\Contracts\NotificationChannelContract;
use Beeralex\Notification\Dto\NotificationMessage;

class WhatsAppChannel implements NotificationChannelContract
{
    public function send(NotificationMessage $message): \Bitrix\Main\Result
    {
        $result = new \Bitrix\Main\Result();
        
        try {
            // –í–∞—à–∞ –ª–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ WhatsApp API
            $api = new WhatsAppApi();
            $api->sendMessage(
                phone: $this->getUserPhone($message->userId),
                text: $this->formatMessage($message)
            );
        } catch (\Exception $e) {
            $result->addError(new \Bitrix\Main\Error($e->getMessage()));
        }
        
        return $result;
    }

    public static function getCode(): string
    {
        return 'whatsapp';
    }

    public static function getDisplayName(): string
    {
        return 'WhatsApp —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
    }

    protected function getUserPhone(int $userId): string
    {
        // –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        $user = \CUser::GetByID($userId)->Fetch();
        return $user['PERSONAL_PHONE'] ?? '';
    }

    protected function formatMessage(NotificationMessage $message): string
    {
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è WhatsApp
        return "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: {$message->eventName}\n" . 
               json_encode($message->fields, JSON_UNESCAPED_UNICODE);
    }
}
```

#### –®–∞–≥ 2: –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞–Ω–∞–ª —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏–µ

–í —Ñ–∞–π–ª–µ `/local/php_interface/init.php`:

```php
use Bitrix\Main\EventManager;

EventManager::getInstance()->addEventHandler(
    'beeralex.notification',
    'OnBuildChannels',
    function() {
        return new \Bitrix\Main\EventResult(
            \Bitrix\Main\EventResult::SUCCESS,
            [
                \App\Notification\Channels\WhatsAppChannel::class
            ]
        );
    }
);
```

#### –®–∞–≥ 3: –î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª –≤ –ë–î —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É

–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `beeralex_notification_channels`:

```sql
INSERT INTO beeralex_notification_channels (CODE, NAME, ACTIVE, SORT)
VALUES ('whatsapp', 'WhatsApp', 'Y', 400);
```

–ò–ª–∏ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚Üí –ö–∞–Ω–∞–ª—ã –¥–æ—Å—Ç–∞–≤–∫–∏ ‚Üí –î–æ–±–∞–≤–∏—Ç—å**.

#### –®–∞–≥ 4: –†–∞—Å—à–∏—Ä–∏—Ç—å Enum (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```php
namespace Beeralex\Notification\Enum;

enum Channel: string
{
    case EMAIL = 'email';
    case SMS = 'sms';
    case TELEGRAM = 'telegram';
    case PUSH = 'push';
    case WHATSAPP = 'whatsapp'; // –î–æ–±–∞–≤–∏—Ç—å
}
```

### –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–±—ã—Ç–∏–µ `OnBeforeSendToChannel`:

```php
use Bitrix\Main\EventManager;

EventManager::getInstance()->addEventHandler(
    'beeralex.notification',
    'OnBeforeSendToChannel',
    function($channel, $message) {
        // –ò–∑–º–µ–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞
        if ($channel->getCode() === 'email') {
            $message->fields['CUSTOM_HEADER'] = '–í–∞–∂–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ';
        }

        return new \Bitrix\Main\EventResult(
            \Bitrix\Main\EventResult::SUCCESS,
            [
                'channel' => $channel,
                'message' => $message,
            ]
        );
    }
);
```

### –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ NotificationManager

–†–∞—Å—à–∏—Ä—å—Ç–µ –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å:

```php
namespace App\Notification;

use Beeralex\Notification\NotificationManager as BaseManager;
use Beeralex\Notification\Dto\NotificationMessage;

class NotificationManager extends BaseManager
{
    /**
     * –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
     */
    public function notifyWithLog(NotificationMessage $message): void
    {
        // –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ø—ã—Ç–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
        \Bitrix\Main\Application::getInstance()
            ->getTaggedCache()
            ->startTagCache('/notifications');
        
        $this->notify($message);
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        file_put_contents(
            '/local/logs/notifications.log',
            date('Y-m-d H:i:s') . " - Sent {$message->eventName} to user {$message->userId}\n",
            FILE_APPEND
        );
    }

    /**
     * –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∫–∞–Ω–∞–ª–∞–º
     */
    public function notifyViaChannels(NotificationMessage $message, array $channels): void
    {
        foreach ($channels as $channelCode) {
            $this->sendToChannel($channelCode, $message);
        }
    }
}
```

–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –≤ DI —á–µ—Ä–µ–∑ `/local/.settings_extra.php`:

```php
use Beeralex\Notification\NotificationManager;
use App\Notification\NotificationManager as AppManager;

return [
    'services' => [
        'value' => [
            NotificationManager::class => [
                'constructor' => static function () {
                    return new AppManager();
                }
            ],
        ]
    ]
];
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–ª–µ–π

```php
namespace App\Notification\Validators;

class NotificationValidator
{
    public static function validate(NotificationMessage $message): bool
    {
        // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Ç–∏–ø–∞ NEW_ORDER
        if ($message->eventName === 'NEW_ORDER') {
            $required = ['USER_NAME', 'ORDER_ID', 'ORDER_TOTAL'];
            foreach ($required as $field) {
                if (empty($message->fields[$field])) {
                    throw new \InvalidArgumentException("Field {$field} is required");
                }
            }
        }

        return true;
    }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
class CustomNotificationManager extends NotificationManager
{
    public function notify(NotificationMessage $message): void
    {
        NotificationValidator::validate($message);
        parent::notify($message);
    }
}
```

---

## REST API

‚ö†Ô∏è **–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ** ‚Äî –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `beeralex.api` –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º–∏ —á–µ—Ä–µ–∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥.

### –ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

```
GET    /api/v1/notifications/preferences/          - –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
POST   /api/v1/notifications/preferences/update/   - –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
GET    /api/v1/notifications/channels/             - –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
GET    /api/v1/notifications/types/                - –°–ø–∏—Å–æ–∫ —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
GET    /api/v1/notifications/history/              - –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
```

### –ü—Ä–∏–º–µ—Ä –±—É–¥—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```javascript
// –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
fetch('/api/v1/notifications/preferences/')
  .then(res => res.json())
  .then(data => {
    console.log('User preferences:', data);
  });

// –û—Ç–∫–ª—é—á–∏—Ç—å email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–∞—Ö
fetch('/api/v1/notifications/preferences/update/', {
  method: 'POST',
  body: JSON.stringify({
    notificationTypeId: 1,
    channelId: 1,
    enabled: false
  })
});
```

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–æ—Å—Ç–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```php
use Beeralex\Notification\NotificationManager;
use Beeralex\Notification\Dto\NotificationMessage;

$manager = new NotificationManager();

$message = new NotificationMessage(
    eventName: 'NEW_ORDER',
    fields: [
        'USER_NAME' => '–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤',
        'ORDER_ID' => 12345,
        'ORDER_TOTAL' => '10 000 —Ä—É–±.',
        'ORDER_DATE' => date('d.m.Y H:i')
    ],
    userId: 100
);

$manager->notify($message);
// –û—Ç–ø—Ä–∞–≤–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –≤—Å–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

### –û—Ç–ø—Ä–∞–≤–∫–∞ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Å–∞–π—Ç–∞

```php
$message = new NotificationMessage(
    eventName: 'PASSWORD_RESET',
    fields: [
        'USER_NAME' => '–ü–µ—Ç—Ä –ü–µ—Ç—Ä–æ–≤',
        'RESET_LINK' => 'https://example.com/reset/abc123'
    ],
    userId: 200,
    lid: 's1' // –£–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–∞–π—Ç
);

$manager->notify($message);
```

### –û—Ç–ø—Ä–∞–≤–∫–∞ —Å —Ñ–∞–π–ª–∞–º–∏ (–≤–ª–æ–∂–µ–Ω–∏—è email)

```php
$message = new NotificationMessage(
    eventName: 'INVOICE_CREATED',
    fields: [
        'USER_NAME' => '–ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞',
        'INVOICE_NUMBER' => 'INV-2025-001',
        'TOTAL_AMOUNT' => '25 000 —Ä—É–±.'
    ],
    userId: 300,
    files: [
        [
            'name' => 'invoice.pdf',
            'content' => file_get_contents('/path/to/invoice.pdf'),
            'type' => 'application/pdf'
        ]
    ]
);

$manager->notify($message);
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```php
use Beeralex\Notification\Contracts\UserNotificationPreferenceRepositoryContract;

$preferenceRepo = service(UserNotificationPreferenceRepositoryContract::class);

// –û—Ç–∫–ª—é—á–∏—Ç—å –≤—Å–µ email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
$types = service(NotificationTypeRepositoryContract::class)->getAllTypes();
$emailChannelId = 1;

foreach ($types as $type) {
    $preferenceRepo->setEnabled(
        userId: 100,
        notificationTypeId: $type['ID'],
        channelId: $emailChannelId,
        enabled: false
    );
}

echo "Email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 100";
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞, —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```php
$preferenceRepo = service(UserNotificationPreferenceRepositoryContract::class);
$typeRepo = service(NotificationTypeRepositoryContract::class);
$channelRepo = service(NotificationChannelRepositoryContract::class);

$userId = 100;
$eventName = 'NEW_ORDER';

// –ü–æ–ª—É—á–∏—Ç—å —Ç–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ –∫–æ–¥—É
$type = $typeRepo->getByCode($eventName);
if (!$type) {
    die("–¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è '{$eventName}' –Ω–µ –Ω–∞–π–¥–µ–Ω");
}

// –ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
$channels = $channelRepo->getActiveChannels();

foreach ($channels as $channel) {
    $isEnabled = $preferenceRepo->isEnabled($userId, $type['ID'], $channel['ID']);
    echo "–ö–∞–Ω–∞–ª {$channel['NAME']}: " . ($isEnabled ? '–≤–∫–ª—é—á–µ–Ω' : '–≤—ã–∫–ª—é—á–µ–Ω') . "\n";
}
```

### –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–ø–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```php
$typeRepo = service(NotificationTypeRepositoryContract::class);

// –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
$typeId = $typeRepo->addIfNotExists(
    code: 'WISHLIST_PRICE_DROP',
    name: '–°–Ω–∏–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–∞ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ'
);

echo "–°–æ–∑–¥–∞–Ω —Ç–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å ID: {$typeId}";

// –ü—Ä–∏–≤—è–∑–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ –∫ —Ç–∏–ø—É
$linkRepo = service(NotificationLinkEventTypeRepositoryContract::class);
$linkRepo->add([
    'EVENT_NAME' => 'PRICE_DROP',
    'EVENT_TYPE_CODE' => 'WISHLIST_PRICE_DROP'
]);
```

### –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–∞–Ω–∞–ª –Ω–∞–ø—Ä—è–º—É—é

```php
use Beeralex\Notification\ChannelFactory;
use Beeralex\Notification\Dto\NotificationMessage;

$channel = ChannelFactory::createChannel('sms');

if ($channel) {
    $message = new NotificationMessage(
        eventName: 'SMS_CODE',
        fields: ['CODE' => '123456'],
        userId: 100
    );

    $result = $channel->send($message);

    if ($result->isSuccess()) {
        echo "SMS –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ";
    } else {
        echo "–û—à–∏–±–∫–∞: " . implode('; ', $result->getErrorMessages());
    }
}
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–æ–¥—É–ª–µ–º –∑–∞–∫–∞–∑–æ–≤

```php
use Bitrix\Main\EventManager;
use Beeralex\Notification\NotificationManager;
use Beeralex\Notification\Dto\NotificationMessage;

// –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
EventManager::getInstance()->addEventHandler(
    'sale',
    'OnOrderAdd',
    function($orderId, $orderFields) {
        $manager = new NotificationManager();

        $message = new NotificationMessage(
            eventName: 'NEW_ORDER',
            fields: [
                'ORDER_ID' => $orderId,
                'USER_NAME' => $orderFields['USER_NAME'] ?? '',
                'ORDER_TOTAL' => $orderFields['PRICE'] ?? 0,
                'ORDER_DATE' => date('d.m.Y H:i'),
            ],
            userId: $orderFields['USER_ID']
        );

        $manager->notify($message);
    }
);
```

### –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º–∏

```php
class NotificationPreferencesComponent extends \CBitrixComponent
{
    public function executeComponent()
    {
        global $USER;
        $userId = $USER->GetID();

        $preferenceRepo = service(UserNotificationPreferenceRepositoryContract::class);
        $typeRepo = service(NotificationTypeRepositoryContract::class);
        $channelRepo = service(NotificationChannelRepositoryContract::class);

        // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ç–∏–ø—ã –∏ –∫–∞–Ω–∞–ª—ã
        $this->arResult['TYPES'] = $typeRepo->getAllTypes();
        $this->arResult['CHANNELS'] = $channelRepo->getActiveChannels();

        // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
        $preferences = $preferenceRepo->getByUser($userId);
        $this->arResult['PREFERENCES'] = [];

        foreach ($preferences as $pref) {
            $key = "{$pref['NOTIFICATION_TYPE_ID']}_{$pref['CHANNEL_ID']}";
            $this->arResult['PREFERENCES'][$key] = $pref['ENABLED'] === 'Y';
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
        if ($this->request->isPost() && check_bitrix_sessid()) {
            foreach ($this->arResult['TYPES'] as $type) {
                foreach ($this->arResult['CHANNELS'] as $channel) {
                    $fieldName = "pref_{$type['ID']}_{$channel['ID']}";
                    $enabled = isset($_POST[$fieldName]);

                    $preferenceRepo->setEnabled(
                        $userId,
                        $type['ID'],
                        $channel['ID'],
                        $enabled
                    );
                }
            }

            LocalRedirect($APPLICATION->GetCurPageParam());
        }

        $this->includeComponentTemplate();
    }
}
```

**–®–∞–±–ª–æ–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞:**

```php
<form method="post">
    <?= bitrix_sessid_post() ?>
    
    <table class="notification-preferences">
        <thead>
            <tr>
                <th>–¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</th>
                <?php foreach ($arResult['CHANNELS'] as $channel): ?>
                    <th><?= htmlspecialchars($channel['NAME']) ?></th>
                <?php endforeach; ?>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($arResult['TYPES'] as $type): ?>
                <tr>
                    <td><?= htmlspecialchars($type['NAME']) ?></td>
                    <?php foreach ($arResult['CHANNELS'] as $channel): ?>
                        <td>
                            <?php
                            $key = "{$type['ID']}_{$channel['ID']}";
                            $checked = $arResult['PREFERENCES'][$key] ?? false;
                            ?>
                            <input type="checkbox"
                                   name="pref_<?= $type['ID'] ?>_<?= $channel['ID'] ?>"
                                   <?= $checked ? 'checked' : '' ?>>
                        </td>
                    <?php endforeach; ?>
                </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
    
    <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
</form>
```

---

## –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è —á–∞—Å—Ç—å

–ú–æ–¥—É–ª—å –≤–∫–ª—é—á–∞–µ—Ç –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

- **–¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π** (`/bitrix/admin/beeralex_notification_types.php`)
- **–ö–∞–Ω–∞–ª—ã –¥–æ—Å—Ç–∞–≤–∫–∏** (`/bitrix/admin/beeralex_notification_channels.php`)
- **–°–≤—è–∑–∏ —Å–æ–±—ã—Ç–∏–π —Å —Ç–∏–ø–∞–º–∏** (`/bitrix/admin/beeralex_notification_link_events.php`)
- **–°–≤—è–∑–∏ —à–∞–±–ª–æ–Ω–æ–≤** (`/bitrix/admin/beeralex_notification_template_links.php`)

–ú–µ–Ω—é —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**.

---

## NotificationLock

–ú–µ—Ö–∞–Ω–∏–∑–º –∑–∞—â–∏—Ç—ã –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–±—ã—Ç–∏–π.

### –ú–µ—Ç–æ–¥—ã

```php
class NotificationLock
{
    // –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–∞–Ω–∞–ª
    public static function lock(string $channel): void;

    // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–∞–Ω–∞–ª
    public static function unlock(string $channel): void;

    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –∫–∞–Ω–∞–ª
    public static function isLocked(string $channel): bool;
}
```

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```php
if (NotificationLock::isLocked('email')) {
    return; // –ö–∞–Ω–∞–ª —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
}

NotificationLock::lock('email');
try {
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
} finally {
    NotificationLock::unlock('email');
}
```

---

## –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### 1. –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ try-finally –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

```php
NotificationLock::lock($channelCode);
try {
    // –í–∞—à –∫–æ–¥
} finally {
    NotificationLock::unlock($channelCode);
}
```

### 2. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏

```php
$result = $channel->send($message);
if (!$result->isSuccess()) {
    log('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' . implode('; ', $result->getErrorMessages()), 6, true);
}
```

### 3. –í–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π

```php
if (empty($message->fields['USER_EMAIL'])) {
    throw new \InvalidArgumentException('Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
}
```

### 4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ DTO

```php
// –ü–ª–æ—Ö–æ
$data = ['event' => 'NEW_ORDER', 'fields' => [...], 'user' => 100];

// –•–æ—Ä–æ—à–æ
$message = new NotificationMessage('NEW_ORDER', [...], 100);
```

### 5. –î–æ–±–∞–≤–ª—è–π—Ç–µ –∫–∞–Ω–∞–ª—ã —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è, –∞ –Ω–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–µ–π –∫–æ–¥–∞ –º–æ–¥—É–ª—è

```php
// –ü—Ä–∞–≤–∏–ª—å–Ω–æ: —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏–µ
EventManager::getInstance()->addEventHandler(
    'beeralex.notification',
    'OnBuildChannels',
    function() {
        return new EventResult(EventResult::SUCCESS, [MyChannel::class]);
    }
);

// –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: –∏–∑–º–µ–Ω—è—Ç—å ChannelRegistry::$defaultChannels
```

---

## –û—Ç–ª–∞–¥–∫–∞ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –í–∫–ª—é—á–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

–í —Ñ–∞–π–ª–µ `/local/modules/beeralex.notification/include/functions.php` –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è `log()`:

```php
function log($message, $level = 6, $force = false)
{
    if ($force || defined('LOG_NOTIFICATION')) {
        \Bitrix\Main\Diag\Debug::writeToFile($message, '', '/local/logs/notification.log');
    }
}
```

–î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –ª–æ–≥–æ–≤ –¥–æ–±–∞–≤—å—Ç–µ –≤ `/local/php_interface/init.php`:

```php
define('LOG_NOTIFICATION', true);
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—à–∏–±–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏

–í—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ `/local/logs/notification.log`:

```bash
tail -f /local/logs/notification.log
```

### –û—Ç–ª–∞–¥–∫–∞ —á–µ—Ä–µ–∑ XDebug

–ü–æ—Å—Ç–∞–≤—å—Ç–µ breakpoint –≤ –º–µ—Ç–æ–¥–µ `NotificationManager::notify()` –¥–ª—è –ø–æ—à–∞–≥–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏

### NotificationChannelRepository

–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞–º–∏ –¥–æ—Å—Ç–∞–≤–∫–∏.

**–ú–µ—Ç–æ–¥—ã:**
- `getActiveChannels(): array` ‚Äî –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
- `getByCode(string $code): ?array` ‚Äî –ø–æ–ª—É—á–∏—Ç—å –∫–∞–Ω–∞–ª –ø–æ –∫–æ–¥—É
- `add(array $data): int` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª
- `update(int $id, array $data): void` ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å –∫–∞–Ω–∞–ª

### NotificationLinkEventTypeRepository

–°–≤—è–∑—å —Å–æ–±—ã—Ç–∏–π —Å —Ç–∏–ø–∞–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

**–ú–µ—Ç–æ–¥—ã:**
- `getByEventName(string $eventName): array` ‚Äî –ø–æ–ª—É—á–∏—Ç—å —Ç–∏–ø—ã –ø–æ –∏–º–µ–Ω–∏ —Å–æ–±—ã—Ç–∏—è
- `linkEventToType(string $eventName, string $typeCode): int` ‚Äî —Å–≤—è–∑–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ —Å —Ç–∏–ø–æ–º

### NotificationsRepository

–ò—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

**–ú–µ—Ç–æ–¥—ã:**
- `getByUser(int $userId, int $limit = 100): array` ‚Äî –∏—Å—Ç–æ—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `add(array $data): int` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –æ–± –æ—Ç–ø—Ä–∞–≤–∫–µ
- `getStatistics(int $userId): array` ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–Ω–∞–ª–∞–º

---

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- **beeralex.core** ‚Äî –±–∞–∑–æ–≤—ã–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ (Repository, TableManagerTrait)
- **beeralex.user** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ‚Äî –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —á–µ—Ä–µ–∑ UserRepositoryContract
- **Bitrix/Main** ‚Äî Events, ORM, Result

---

## –õ–∏—Ü–µ–Ω–∑–∏—è

–ü—Ä–æ–ø—Ä–∏–µ—Ç–∞—Ä–Ω—ã–π –º–æ–¥—É–ª—å. ¬© beeralex

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ú–æ–¥—É–ª—å **beeralex.notification** –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≥–∏–±–∫—É—é –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º—É—é —Å–∏—Å—Ç–µ–º—É –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π:

- ‚úÖ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –¥–æ—Å—Ç–∞–≤–∫–∏
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
- ‚úÖ –ü–µ—Ä–µ—Ö–≤–∞—Ç–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π Bitrix
- ‚úÖ Event-driven –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
- ‚úÖ –ó–∞—â–∏—Ç—ã –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏ –∏ –æ—à–∏–±–æ–∫

–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–±—ã—Ç–∏—è –∏ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤, –∏–∑–±–µ–≥–∞—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–æ–¥–∞ –º–æ–¥—É–ª—è –Ω–∞–ø—Ä—è–º—É—é.
